<html>
    <head>
        <style>
            body {
                font-family: "Courier New", Courier, monospace;
                white-space: nowrap;
            }

            .execwrapper {
                width: 750px;
                height: 500px;
                margin: 25px auto 25px auto;
                border: 10px solid blue;
            }

            .execwrapper table {
                table-layout: fixed;
                width: 100%;
                height: 100%;
            }

            table.execution, .execution td {
                text-align: center;
                border: 1px solid black;
            }

            .disasm {
                width: 50%;
            }

            table.codetable {
                height: auto ;
            }

            .codetable td {
                border: none;
                text-align: left;
                font-size: 10px;
            }

            .green {
                background-color: #93F593;
            }

            .codetable tr {
                height: 10px;
            }

            div.codewrapper {
                height: 350px;
                overflow-y: scroll;
            }

            table.codetable {
                table-layout: fixed;
            }

            .codetable td:nth-child(1) {
                width: 10%;
            }

            .codetable td:nth-child(2) {
                width: 90%;
            }
        </style>
    </head>

    <body>
        <template id="exectemplate">
            <div class="execwrapper">
                <table class="execution">
                    <tbody>
                        <tr><td class="exectitle" colspan="2">Execution XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</td></tr>
                        <tr>
                            <td class="disasm">
                                <div class="codewrapper">
                                    <table class="codetable">
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                            <td class="memory">
                                <table class="memtable">
                                    <tbody>
                                        <tr><td>Stack</td></tr>
                                        <tr><td>Scratch</td></tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        <tr class="globals">
                            <td class="pc">PC: foo</td>
                            <td class="error">Error: null</td>
                        </tr>
                        <tr class="actions">
                            <td><button>Set breakpoints and continue</button></td><td><button>Single step</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </template>

        <div id="sessions">
        </div>

        <script>
            var sessions = {};
            function addExec(state) {
                var template = document.getElementById("exectemplate");
                template = template.content.firstElementChild;
                var clone = template.cloneNode(true)
                setExecContents(clone, state);

                var sesslist = document.getElementById("sessions");
                sesslist.appendChild(clone);

                // Add to global session store so we can update
                sessions[state["execid"]] = clone;
            }

            function setExecContents(exec, state) {
                exec.querySelector(".exectitle").innerText = "Execution " + state["execid"];

                var codelines = state["disasm"].split("\n");
                var codetable = exec.querySelector(".codetable");

                // Only update if needed
                if (codetable.rows.length == 0) {
                    // Last line is always a blank newline, so skip it
                    for (var i = 0; i < codelines.length; i++) {
                        var row = codetable.insertRow(-1)
                        var lineno = row.insertCell(0);
                        var codeline = row.insertCell(1);
                        lineno.innerText = i;
                        lineno.innerText = lineno.innerText.padStart(4, '0');
                        codeline.innerText = codelines[i];
                    }
                }

                var pc = exec.querySelector(".pc");
                pc.innerText = "PC: " + state["pc"];

                var error = exec.querySelector(".error");
                error.innerText = "Error: " + state["error"];

                var curHighlight = codetable.querySelector(".green");
                if (curHighlight) {
                    curHighlight.classList.toggle("green", false);
                }

                var highlightLine = pcToLine(state["pc"], state["disasm"], state["pctooffset"]);
                var rows = codetable.querySelectorAll("tr");
                rows[highlightLine].classList.toggle("green", true);
                rows[highlightLine].scrollIntoView({"behavior": "smooth", "block": "center"});
            }

            function pcToLine(pc, disasm, pcToOffset) {
                if (pcToOffset.length == 0) {
                    return 0;
                }

                var offset = 0;
                for (var i = 0; i < pcToOffset.length; i++) {
                    if (pcToOffset[i]["pc"] >= pc) {
                        offset = pcToOffset[i]["offset"];
                        break;
                    }
                }

                if (i == pcToOffset.length) {
                    offset = pcToOffset[pcToOffset.length - 1]["offset"];
                }

                return disasm.substring(0, offset).split("\n").length - 1
            }

            // addExec({"pc":1,"stack":[],"scratch":[{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"},{"t":"u"}],"disasm":"// version 2\nintcblock 0 1\nbytecblock 0x68656c6c6f 0x7772697465 0x636865636b 0x666f6f 0x626172\ntxn ApplicationArgs 0\nbytec_0\n==\nbnz label1\ntxn ApplicationArgs 0\nbytec_1\n==\nbnz label2\ntxn ApplicationArgs 0\nbytec_2\n==\nintc_0\nintc_0\nbytec_3\napp_local_get\nintc_0\n==\nbnz label3\ntxn ApplicationArgs 1\n==\n\u0026\u0026\nintc_1\nbnz label4\nlabel2:\nintc_0\nbytec_3\nbytec 4\napp_local_put\nintc_1\nbnz label1\nlabel1:\nintc_1\nintc_1\nbnz label4\nlabel3:\nintc_0\nintc_1\nbnz label4\n","pctooffset":[{"pc":1,"offset":13},{"pc":5,"offset":27},{"pc":33,"offset":95},{"pc":36,"offset":117},{"pc":37,"offset":125},{"pc":38,"offset":128},{"pc":41,"offset":139},{"pc":44,"offset":161},{"pc":45,"offset":169},{"pc":46,"offset":172},{"pc":49,"offset":183},{"pc":52,"offset":205},{"pc":53,"offset":213},{"pc":54,"offset":216},{"pc":55,"offset":223},{"pc":56,"offset":230},{"pc":57,"offset":238},{"pc":58,"offset":252},{"pc":59,"offset":259},{"pc":60,"offset":262},{"pc":63,"offset":273},{"pc":66,"offset":295},{"pc":67,"offset":298},{"pc":68,"offset":301},{"pc":69,"offset":308},{"pc":72,"offset":327},{"pc":73,"offset":334},{"pc":74,"offset":342},{"pc":76,"offset":350},{"pc":77,"offset":364},{"pc":78,"offset":371},{"pc":81,"offset":390},{"pc":82,"offset":397},{"pc":83,"offset":404},{"pc":86,"offset":423},{"pc":87,"offset":430},{"pc":88,"offset":437}],"execid":"PD2HPDBATVA73GHR7LSPJA47SH53B7WZZVASTV3ETPAF7TEJBD6Q","error":""});

        </script>

        <script>
            const socket = new WebSocket('ws://localhost:9392/ws');

            socket.addEventListener('open', function (event) {
                socket.send('opened');
            });

            socket.addEventListener('message', function (event) {
                var msg = JSON.parse(event.data);

                if (msg["event"] === "registered") {
                    addExec(msg["state"])
                }

                if (msg["event"] === "updated" || msg["event"] === "completed") {
                    setExecContents(sessions[msg["state"]["execid"]], msg["state"]);
                }

                if (msg["event"] === "completed") {
                    delete sessions[msg["state"]["execid"]];
                }

                if (msg["event"] === "registered") {
                    var req = new XMLHttpRequest();
                    req.open("POST", "/exec/config", false);
                    req.setRequestHeader("Content-Type", "application/json");
                    // break on every line
                    req.send(JSON.stringify({"execid": msg["state"]["execid"], "breakonpc": 0}));
                }

                setTimeout(function(){
                    if (msg["event"] === "registered" || msg["event"] === "updated") {
                        var req = new XMLHttpRequest();
                        req.open("POST", "/exec/continue");
                        req.setRequestHeader("Content-Type", "application/json");
                        req.send(JSON.stringify({"execid": msg["state"]["execid"]}));
                    }
                }, 500);
            });
        </script>
    </body>
</html>
